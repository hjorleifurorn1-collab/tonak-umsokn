<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ums√≥kn - T√≥nlistarsk√≥linn √° Akureyri</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8B7355;
            --color-primary-dark: #6B5A45;
            --color-primary-light: #D4A574;
            --color-background: #F5E6D3;
            --color-background-light: #FDF8F3;
            --color-text: #4A4A4A;
            --color-text-light: #7A7A7A;
            --color-white: #FFFFFF;
            --color-error: #C45C5C;
            --color-success: #5C8B5C;
            --color-border: #E0D5C7;
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'Source Sans 3', -apple-system, sans-serif;
            --shadow-soft: 0 4px 20px rgba(139, 115, 85, 0.1);
            --shadow-medium: 0 8px 30px rgba(139, 115, 85, 0.15);
            --radius-small: 4px;
            --radius-medium: 8px;
            --radius-large: 16px;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-background);
            min-height: 100vh;
        }

        /* Container */
        .form-container {
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            letter-spacing: 0.02em;
        }

        .form-header p {
            color: var(--color-text-light);
            font-size: 1.1rem;
            font-weight: 300;
        }

        /* Progress indicator */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 8px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-border);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            height: 2px;
            background: var(--color-primary);
            transform: translateY(-50%);
            z-index: 2;
            transition: width var(--transition-medium);
        }

        .step-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-white);
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text-light);
            position: relative;
            z-index: 3;
            transition: all var(--transition-medium);
        }

        .step-indicator.active {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: var(--color-white);
        }

        .step-indicator.completed {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: var(--color-white);
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--color-text-light);
            text-align: center;
            width: 36px;
            transition: color var(--transition-fast);
        }

        .step-label.active {
            color: var(--color-primary);
            font-weight: 500;
        }

        /* Form card */
        .form-card {
            background: var(--color-white);
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-medium);
            padding: 40px;
            margin-bottom: 24px;
        }

        /* Step sections */
        .form-step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .step-description {
            color: var(--color-text-light);
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 24px;
        }

        .field-description {
            font-size: 0.9rem;
            color: var(--color-text-light);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-text);
            font-size: 0.95rem;
        }

        label .required {
            color: var(--color-error);
            margin-left: 2px;
        }

        label .optional {
            color: var(--color-text-light);
            font-weight: 400;
            font-size: 0.85rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-medium);
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--color-text);
            background: var(--color-white);
            transition: all var(--transition-fast);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }

        input:disabled,
        select:disabled {
            background: var(--color-background-light);
            color: var(--color-text-light);
            cursor: not-allowed;
        }

        input.error,
        select.error {
            border-color: var(--color-error);
        }

        .error-message {
            color: var(--color-error);
            font-size: 0.85rem;
            margin-top: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Info box */
        .info-box {
            background: var(--color-background-light);
            border-left: 3px solid var(--color-primary);
            padding: 16px 20px;
            border-radius: 0 var(--radius-medium) var(--radius-medium) 0;
            margin-bottom: 24px;
        }

        .info-box p {
            font-size: 0.9rem;
            color: var(--color-text);
            margin: 0;
        }

        .info-box .age-display {
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Checkboxes */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--color-primary);
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            line-height: 1.5;
        }

        .checkbox-item label a {
            color: var(--color-primary);
            text-decoration: underline;
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            gap: 24px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--color-primary);
            cursor: pointer;
        }

        .radio-item label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
        }

        /* Buttons */
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 14px 32px;
            border-radius: var(--radius-medium);
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-white);
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: var(--color-background-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-add {
            background: transparent;
            color: var(--color-primary);
            border: 1px dashed var(--color-primary);
            width: 100%;
            padding: 12px;
            margin-top: 16px;
        }

        .btn-add:hover {
            background: var(--color-background-light);
            border-style: solid;
        }

        /* Tengili√∞ur card */
        .contact-card {
            background: var(--color-background-light);
            border-radius: var(--radius-medium);
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
        }

        .contact-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .contact-card-title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .btn-remove {
            background: transparent;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
        }

        .btn-remove:hover {
            text-decoration: underline;
        }

        /* Subject selection */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .subject-option {
            padding: 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-white);
        }

        .subject-option:hover {
            border-color: var(--color-primary-light);
            background: var(--color-background-light);
        }

        .subject-option.selected {
            border-color: var(--color-primary);
            background: var(--color-background-light);
            box-shadow: 0 0 0 2px rgba(139, 115, 85, 0.2);
        }

        .subject-option input {
            display: none;
        }

        .subject-option .subject-name {
            font-weight: 500;
            color: var(--color-text);
        }

        .subject-option .subject-dept {
            font-size: 0.85rem;
            color: var(--color-text-light);
            margin-top: 4px;
        }

        /* Terms box */
        .terms-box {
            background: var(--color-background-light);
            border-radius: var(--radius-medium);
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 24px;
            font-size: 0.9rem;
            line-height: 1.7;
            border: 1px solid var(--color-border);
        }

        .terms-box h4 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--color-primary);
            margin-bottom: 12px;
        }

        .terms-box p {
            margin-bottom: 12px;
        }

        /* Success message */
        .success-message {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--color-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
        }

        .success-message h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 12px;
        }

        .success-message p {
            color: var(--color-text-light);
            font-size: 1.1rem;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Choice buttons for start screen */
        .choice-buttons {
            display: flex;
            gap: 20px;
            margin-top: 32px;
        }

        .btn-choice {
            flex: 1;
            padding: 32px 24px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-large);
            background: var(--color-white);
            cursor: pointer;
            transition: all var(--transition-medium);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .btn-choice:hover {
            border-color: var(--color-primary);
            background: var(--color-background-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-choice.small {
            padding: 20px;
            flex-direction: row;
            justify-content: center;
        }

        .btn-choice.secondary {
            background: var(--color-background-light);
        }

        .choice-icon {
            font-size: 2.5rem;
        }

        .choice-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .btn-choice.small .choice-title {
            font-size: 1rem;
        }

        .choice-desc {
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        @media (max-width: 600px) {
            .choice-buttons {
                flex-direction: column;
            }

            .btn-choice {
                padding: 24px 20px;
            }
        }

        /* Textarea */
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-medium);
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--color-text);
            background: var(--color-white);
            transition: all var(--transition-fast);
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--color-border);
            margin: 32px 0;
        }

        /* Section subtitle */
        .section-subtitle {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--color-primary-dark);
            margin-bottom: 16px;
            margin-top: 32px;
        }

        .section-subtitle:first-of-type {
            margin-top: 0;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .form-container {
                padding: 20px 16px;
            }

            .form-card {
                padding: 24px 20px;
            }

            .form-header h1 {
                font-size: 2rem;
            }

            .step-title {
                font-size: 1.5rem;
            }

            .button-group {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
            }

            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* Validation Modal */
        .validation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
        }

        .validation-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .validation-modal-content {
            background: var(--color-white);
            border-radius: var(--radius-large);
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-medium);
            transform: scale(0.9);
            transition: transform var(--transition-medium);
        }

        .validation-modal.visible .validation-modal-content {
            transform: scale(1);
        }

        .validation-modal-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .validation-modal-message {
            color: var(--color-text);
            margin-bottom: 24px;
            white-space: pre-line;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <!-- Header -->
        <div class="form-header">
            <h1>Ums√≥kn um n√°msvist</h1>
            <p>T√≥nlistarsk√≥linn √° Akureyri</p>
        </div>

        <!-- Progress - hidden on start screen -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-steps">
                <div class="progress-line" id="progressLine"></div>
                <div class="step-indicator active" data-step="1">1</div>
                <div class="step-indicator" data-step="2">2</div>
                <div class="step-indicator" data-step="3">3</div>
                <div class="step-indicator" data-step="4">4</div>
                <div class="step-indicator" data-step="5">5</div>
            </div>
            <div class="step-labels" id="stepLabels">
                <span class="step-label active">Nemandi</span>
                <span class="step-label">Uppl√Ωsingar</span>
                <span class="step-label">Tengili√∞ir</span>
                <span class="step-label">N√°msgrein</span>
                <span class="step-label">Sta√∞festing</span>
            </div>
        </div>

        <!-- Form Card -->
        <div class="form-card">
            <!-- Start Screen: Choose path -->
            <div class="form-step active" data-step="start">
                <h2 class="step-title">Ums√≥kn um n√°msvist</h2>
                <p class="step-description">Er nemandinn a√∞ endurn√Ωja sk√≥lavist e√∞a s√¶kja um √≠ fyrsta skipti?</p>

                <div class="choice-buttons">
                    <button type="button" class="btn-choice" onclick="startRenewal()">
                        <span class="choice-icon">üîÑ</span>
                        <span class="choice-title">Endurn√Ωja sk√≥lavist</span>
                        <span class="choice-desc">Nemandi hefur √°√∞ur veri√∞ skr√°√∞ur √≠ sk√≥lann</span>
                    </button>
                    <button type="button" class="btn-choice" onclick="startNewApplication()">
                        <span class="choice-icon">‚ú®</span>
                        <span class="choice-title">N√Ω ums√≥kn</span>
                        <span class="choice-desc">Nemandi s√¶kir um √≠ fyrsta skipti</span>
                    </button>
                </div>
            </div>

            <!-- Renewal Step 1: Enter kennitala -->
            <div class="form-step" data-step="renewal-1">
                <h2 class="step-title">Endurn√Ωja sk√≥lavist</h2>
                <p class="step-description">Sl√°√∞u inn kennit√∂lu nemanda til a√∞ leita a√∞ skr√°ningu.</p>

                <div class="form-group">
                    <label for="renewalKennitala">Kennitala nemanda <span class="required">*</span></label>
                    <input type="text" id="renewalKennitala" name="renewalKennitala" placeholder="0000000000" maxlength="10">
                    <div class="error-message" id="renewalKennitalaError">Kennitala ver√∞ur a√∞ vera 10 t√∂lustafir</div>
                </div>

                <div class="info-box hidden" id="renewalNotFound" style="border-left-color: var(--color-error);">
                    <p><strong>Engin skr√°ning fannst fyrir √æessa kennit√∂lu.</strong></p>
                    <p>Ef nemandinn hefur aldrei veri√∞ skr√°√∞ur, vinsamlegast veldu "N√Ω ums√≥kn".</p>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStart()">Til baka</button>
                    <button type="button" class="btn btn-primary" id="btnSearchRenewal" disabled onclick="searchForRenewal()">Leita</button>
                </div>
            </div>

            <!-- Renewal Step 2: Confirm or request changes -->
            <div class="form-step" data-step="renewal-2">
                <h2 class="step-title">Skr√°ning fannst</h2>
                <p class="step-description">Vi√∞ fundum skr√°ningu fyrir √æessa kennit√∂lu fr√° fyrra sk√≥la√°ri. Viltu endurn√Ωja sk√≥lavist?</p>

                <div class="info-box" id="renewalStudentInfo">
                    <p><strong>Nemandi:</strong> <span id="renewalStudentName">‚Äî</span></p>
                    <p><strong>N√∫verandi n√°msgrein:</strong> <span id="renewalStudentSubject">‚Äî</span></p>
                </div>

                <div class="choice-buttons" style="margin-top: 24px;">
                    <button type="button" class="btn-choice small" onclick="confirmRenewal()">
                        <span class="choice-title">J√°, endurn√Ωja √° sama hlj√≥√∞f√¶ri</span>
                    </button>
                    <button type="button" class="btn-choice small secondary" onclick="requestChanges()">
                        <span class="choice-title">Nei, √≥ska eftir breytingum</span>
                    </button>
                </div>

                <div class="button-group" style="margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="goToStep('renewal-1')">Til baka</button>
                </div>
            </div>

            <!-- Renewal Step 3a: Simple renewal confirmation -->
            <div class="form-step" data-step="renewal-confirm">
                <h2 class="step-title">Sta√∞festa endurn√Ωjun</h2>
                <p class="step-description">Nemandinn ver√∞ur skr√°√∞ur √°fram √≠ sama n√°mi. Vinsamlegast far√∞u yfir og sam√æykktu vi√∞skiptaskilm√°la.</p>

                <div class="terms-box">
                    <h4>Vi√∞skiptaskilm√°lar</h4>
                    <p>Gjaldskr√° sk√≥lans er h√°√∞ √°kv√∂r√∞unum b√¶jarsj√≥√∞s um gjaldskr√°rh√¶kkanir. T√≥nlistarsk√≥linn √° Akureyri √°skilur s√©r r√©tt til h√¶kkunar sk√≥la- og hlj√≥√∞f√¶raleigugjalda √° samningst√≠manum √≠ samr√¶mi vi√∞ √°kvar√∞anir b√¶jarsj√≥√∞s.</p>
                    <p>Sk√≥lagj√∂ld t√≥nlistarsk√≥lans eru greidd fyrir eina √∂nn √≠ einu en til hagr√¶√∞ingar fyrir grei√∞endur dreifast grei√∞slur sk√≥lagjalda √° 4 jafnar grei√∞slur fyrir hverja √∂nn me√∞ gjalddaga ca. 15. √°g., 15.sept., 15. okt., 15. n√≥v. fyrir haust√∂nn og gjalddaga 15. jan., 15. feb., 15. mars, 15. apr√≠l fyrir vor√∂nn.</p>
                    <p>Einungis er m√∂gulegt a√∞ segja upp samningi einu sinni √° √°ri, fr√° og me√∞ √°ram√≥tum og rennur uppsagnarfrestur fyrir vor√∂nn √∫t 1. n√≥vember √°r hvert. Til √æess a√∞ upps√∂gn s√© gild ver√∞ur a√∞ segja samningi upp skriflega me√∞ t√∂lvup√≥sti √° netfangi√∞ tonak@tonak.is.</p>
                    <p>Undantekning fr√° √æessu eru nemendur √≠ framhaldsn√°mi √° hlj√≥√∞f√¶ri og nemendur √≠ mi√∞ og framhaldsn√°mi √≠ s√∂ng. √ûessir nemendur geta ekki sagt upp n√°mi og sk√≥lavist √æeirra er bundin fyrir allt sk√≥la√°ri√∞ me√∞ √æessari ums√≥kn.</p>
                    <p>T√≥nlistarsk√≥linn √° Akureyri √°skilur s√©r birtingar- og dreifingarr√©tt √° √∂llu √æv√≠ hlj√≥√∞- og myndefni sem teki√∞ er upp af nemendum sk√≥lans √° vi√∞bur√∞um sem sk√≥linn stendur fyrir sem og √≠ kennslustundum.</p>
                    <p>Me√∞ √æv√≠ a√∞ senda inn ums√≥kn √≠ T√≥nlistarsk√≥lann √° Akureyri sam√æykkir ums√¶kjandi √æ√° skilm√°la sem birtast √≠ skjali √æessu sem og gjaldskr√° sk√≥lans og taka skilm√°larnir gildi strax og ums√¶kjandi hefur fengi√∞ sta√∞festingu √° n√°msvist.</p>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="renewalSamthykkiSkilmala" name="renewalSamthykkiSkilmala" required>
                        <label for="renewalSamthykkiSkilmala">√âg sam√æykki <strong>vi√∞skiptaskilm√°la</strong> T√≥nlistarsk√≥lans √° Akureyri <span class="required">*</span></label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="renewalFristundastyrkur" name="renewalFristundastyrkur">
                        <label for="renewalFristundastyrkur">√âg √≥ska eftir a√∞ nota fr√≠stundastyrk</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="renewalMyndefni" name="renewalMyndefni">
                        <label for="renewalMyndefni">√âg sam√æykki a√∞ myndefni sem teki√∞ er upp af nemanda megi nota √° uppl√Ωsingas√≠√∞um sk√≥lans</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="renewalHljodfaraleiga" name="renewalHljodfaraleiga">
                        <label for="renewalHljodfaraleiga">√âg √≥ska eftir hlj√≥√∞f√¶raleigu</label>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label for="renewalNotes">Athugasemdir <span class="optional">(valkv√¶tt)</span></label>
                    <textarea id="renewalNotes" name="renewalNotes" rows="3" placeholder="Ef √æ√∫ vilt koma einhverju √° framf√¶ri..."></textarea>
                </div>

                <div class="form-group">
                    <label for="renewalEmail">Netfang fyrir sta√∞festingu <span class="required">*</span></label>
                    <input type="email" id="renewalEmail" name="renewalEmail" placeholder="netfang@d√¶mi.is">
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep('renewal-2')">Til baka</button>
                    <button type="button" class="btn btn-primary" onclick="submitRenewal()">Senda ums√≥kn</button>
                </div>
            </div>

            <!-- Renewal Step 3b: Request changes -->
            <div class="form-step" data-step="renewal-changes">
                <h2 class="step-title">√ìska eftir breytingum</h2>
                <p class="step-description">Hva√∞a breytingum √≥skar √æ√∫ eftir?</p>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="changeInstrument" name="changeInstrument">
                        <label for="changeInstrument">Skipta um hlj√≥√∞f√¶ri / n√°msgrein</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="changeTeacher" name="changeTeacher">
                        <label for="changeTeacher">Skipta um kennara</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="changeRatio" name="changeRatio">
                        <label for="changeRatio">Breyta n√°mshlutfalli (heilt/h√°lft n√°m)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="changeOther" name="changeOther">
                        <label for="changeOther">Anna√∞</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label for="changeNotes">N√°nari l√Ωsing √° breytingum <span class="required">*</span></label>
                    <textarea id="changeNotes" name="changeNotes" rows="4" placeholder="Vinsamlegast l√Ωstu breytingunum sem √æ√∫ √≥skar eftir..."></textarea>
                </div>

                <div class="divider"></div>

                <div class="terms-box">
                    <h4>Vi√∞skiptaskilm√°lar</h4>
                    <p>Gjaldskr√° sk√≥lans er h√°√∞ √°kv√∂r√∞unum b√¶jarsj√≥√∞s um gjaldskr√°rh√¶kkanir. T√≥nlistarsk√≥linn √° Akureyri √°skilur s√©r r√©tt til h√¶kkunar sk√≥la- og hlj√≥√∞f√¶raleigugjalda √° samningst√≠manum √≠ samr√¶mi vi√∞ √°kvar√∞anir b√¶jarsj√≥√∞s.</p>
                    <p>Sk√≥lagj√∂ld t√≥nlistarsk√≥lans eru greidd fyrir eina √∂nn √≠ einu en til hagr√¶√∞ingar fyrir grei√∞endur dreifast grei√∞slur sk√≥lagjalda √° 4 jafnar grei√∞slur fyrir hverja √∂nn.</p>
                    <p>Einungis er m√∂gulegt a√∞ segja upp samningi einu sinni √° √°ri, fr√° og me√∞ √°ram√≥tum og rennur uppsagnarfrestur fyrir vor√∂nn √∫t 1. n√≥vember √°r hvert.</p>
                    <p>Me√∞ √æv√≠ a√∞ senda inn ums√≥kn √≠ T√≥nlistarsk√≥lann √° Akureyri sam√æykkir ums√¶kjandi √æ√° skilm√°la sem birtast √≠ skjali √æessu sem og gjaldskr√° sk√≥lans.</p>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="changeSamthykkiSkilmala" name="changeSamthykkiSkilmala" required>
                        <label for="changeSamthykkiSkilmala">√âg sam√æykki <strong>vi√∞skiptaskilm√°la</strong> T√≥nlistarsk√≥lans √° Akureyri <span class="required">*</span></label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="changeFristundastyrkur" name="changeFristundastyrkur">
                        <label for="changeFristundastyrkur">√âg √≥ska eftir a√∞ nota fr√≠stundastyrk</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="changeMyndefni" name="changeMyndefni">
                        <label for="changeMyndefni">√âg sam√æykki a√∞ myndefni sem teki√∞ er upp af nemanda megi nota √° uppl√Ωsingas√≠√∞um sk√≥lans</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="changeHljodfaraleiga" name="changeHljodfaraleiga">
                        <label for="changeHljodfaraleiga">√âg √≥ska eftir hlj√≥√∞f√¶raleigu</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label for="changeEmail">Netfang fyrir sta√∞festingu <span class="required">*</span></label>
                    <input type="email" id="changeEmail" name="changeEmail" placeholder="netfang@d√¶mi.is">
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep('renewal-2')">Til baka</button>
                    <button type="button" class="btn btn-primary" onclick="submitChangeRequest()">Senda ums√≥kn</button>
                </div>
            </div>

            <!-- Step 1: Kennitala (for new applications) -->
            <div class="form-step" data-step="1">
                <h2 class="step-title">N√Ω ums√≥kn - Kennitala nemanda</h2>
                <p class="step-description">Sl√°√∞u inn kennit√∂lu nemanda til a√∞ hefja ums√≥kn.</p>

                <div class="form-group">
                    <label for="kennitala">Kennitala <span class="required">*</span></label>
                    <input type="text" id="kennitala" name="kennitala" placeholder="0000000000" maxlength="10" pattern="[0-9]{10}">
                    <div class="error-message" id="kennitalaError">Kennitala ver√∞ur a√∞ vera 10 t√∂lustafir</div>
                </div>

                <div class="info-box hidden" id="ageInfo">
                    <p>F√¶√∞ingardagur: <span id="birthDate"></span></p>
                    <p>Aldur: <span class="age-display" id="ageDisplay"></span></p>
                    <p>Aldursflokkur: <span class="age-display" id="ageGroup"></span></p>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStart()">Til baka</button>
                    <button type="button" class="btn btn-primary" id="btnNext1" disabled>√Åfram</button>
                </div>
            </div>

            <!-- Step 2: Uppl√Ωsingar nemanda -->
            <div class="form-step" data-step="2">
                <h2 class="step-title">Uppl√Ωsingar nemanda</h2>
                <p class="step-description">Vinsamlegast fylltu √∫t eftirfarandi uppl√Ωsingar.</p>

                <div class="section-subtitle">Grunnuppl√Ωsingar</div>

                <div class="form-group">
                    <label for="nafn">Fullt nafn <span class="required">*</span></label>
                    <input type="text" id="nafn" name="nafn" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="logheimili">L√∂gheimili <span class="required">*</span></label>
                        <input type="text" id="logheimili" name="logheimili" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                    </div>
                    <div class="form-group">
                        <label for="sveitarfelag">Sveitarf√©lag <span class="required">*</span></label>
                        <input type="text" id="sveitarfelag" name="sveitarfelag" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                    </div>
                </div>

                <div class="section-subtitle">Samskiptauppl√Ωsingar</div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="simi1">S√≠man√∫mer 1 <span class="required">*</span></label>
                        <input type="tel" id="simi1" name="simi1" placeholder="000-0000">
                    </div>
                    <div class="form-group">
                        <label for="simi2">S√≠man√∫mer 2 <span class="optional">(valkv√¶tt)</span></label>
                        <input type="tel" id="simi2" name="simi2" placeholder="000-0000">
                    </div>
                </div>

                <div class="form-group">
                    <label for="netfang">Netfang <span class="required">*</span></label>
                    <input type="email" id="netfang" name="netfang" placeholder="netfang@d√¶mi.is">
                </div>

                <div class="section-subtitle">Anna√∞ heimili <span class="optional">(ef vi√∞ √°)</span></div>

                <div class="form-group">
                    <label for="annadHeimili">Heimilisfang</label>
                    <input type="text" id="annadHeimili" name="annadHeimili" placeholder="G√∂tuheiti og h√∫sn√∫mer">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="postnumerAnnad">P√≥stn√∫mer</label>
                        <input type="text" id="postnumerAnnad" name="postnumerAnnad" placeholder="000">
                    </div>
                    <div class="form-group">
                        <label for="sveitarfelagAnnad">Sveitarf√©lag</label>
                        <input type="text" id="sveitarfelagAnnad" name="sveitarfelagAnnad" placeholder="Sveitarf√©lag">
                    </div>
                </div>

                <!-- Grunnsk√≥li/Framhaldssk√≥li - s√Ωnist eftir aldri -->
                <div id="skoliSection" class="hidden">
                    <div class="section-subtitle">Sk√≥li</div>
                    <div class="form-group">
                        <label for="skoli" id="skoliLabel">Grunnsk√≥li</label>
                        <select id="skoli" name="skoli">
                            <option value="">Veldu sk√≥la...</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="skoliAnnadGroup">
                        <label for="skoliAnnad">Hva√∞a sk√≥li? <span class="required">*</span></label>
                        <input type="text" id="skoliAnnad" name="skoliAnnad" placeholder="Nafn sk√≥la">
                    </div>
                    
                    <!-- St√∫dentspr√≥fsbraut - bara fyrir framhaldssk√≥lanemendur -->
                    <div class="form-group hidden" id="studentsprofStep2Group" style="margin-top: 24px;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="studentsprofStep2" name="studentsprofStep2">
                            <label for="studentsprofStep2">√âg s√¶ki um √° st√∫dentspr√≥fsbraut</label>
                        </div>
                        <div class="info-box" style="margin-top: 12px; font-size: 0.9rem;">
                            <p><strong>Uppl√Ωsingar um st√∫dentspr√≥fsbraut:</strong></p>
                            <p>Nemendur sem hafa s√≥tt um t√≥nlistarkj√∂rsvi√∞, t√≥nlistarbraut e√∞a t√≥nlistars√©rh√¶fingu √≠ s√≠num framhaldssk√≥la ver√∞a a√∞ haka vi√∞ h√©r til a√∞ ums√≥kn √æeirra taki gildi.</p>
                            <p style="margin-top: 8px;">Mikilv√¶gt er a√∞ nemendur uppl√Ωsi sinn framhaldssk√≥la um a√∞ √æeir hafi s√≥tt um st√∫dentspr√≥fsbraut √≠ samstarfi vi√∞ TonAk.</p>
                            <p style="margin-top: 8px;"><em>Nemendur sem stunda n√°m vi√∞ a√∞rar brautir/kj√∂rsvi√∞ framhaldssk√≥la √æurfa ekki a√∞ haka vi√∞ h√©r.</em></p>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Til baka</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(3)">√Åfram</button>
                </div>
            </div>

            <!-- Step 3: Tengili√∞ir -->
            <div class="form-step" data-step="3">
                <h2 class="step-title">Tengili√∞ir</h2>
                <p class="step-description" id="contactDescription">Vinsamlegast skr√°√∞u uppl√Ωsingar um forr√°√∞amann/forr√°√∞amenn.</p>

                <!-- For 18+ - nemandi er sj√°lfur tengili√∞ur -->
                <div id="selfContactInfo" class="hidden">
                    <div class="info-box">
                        <p>√ûar sem nemandi er 18 √°ra e√∞a eldri er hann/h√∫n sj√°lfur tengili√∞ur og grei√∞andi. Uppl√Ωsingarnar sem √æ√∫ fylltir √∫t √≠ skrefi 2 ver√∞a nota√∞ar.</p>
                    </div>
                </div>

                <!-- For under 18 -->
                <div id="contactsContainer">
                    <!-- Forr√°√∞ama√∞ur 1 - alltaf s√Ωnilegur fyrir b√∂rn -->
                    <div class="contact-card" id="contact1">
                        <div class="contact-card-header">
                            <span class="contact-card-title">Forr√°√∞ama√∞ur 1</span>
                        </div>

                        <div class="form-group">
                            <label for="tengilidur1_kennitala">Kennitala <span class="required">*</span></label>
                            <input type="text" id="tengilidur1_kennitala" name="tengilidur1_kennitala" placeholder="0000000000" maxlength="10">
                        </div>

                        <div class="form-group">
                            <label for="tengilidur1_nafn">Nafn <span class="required">*</span></label>
                            <input type="text" id="tengilidur1_nafn" name="tengilidur1_nafn" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                        </div>

                        <div class="form-group">
                            <label for="tengilidur1_heimili">Heimilisfang</label>
                            <input type="text" id="tengilidur1_heimili" name="tengilidur1_heimili" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tengilidur1_postnumer">P√≥stn√∫mer</label>
                                <input type="text" id="tengilidur1_postnumer" name="tengilidur1_postnumer" placeholder="000" disabled>
                            </div>
                            <div class="form-group">
                                <label for="tengilidur1_sveitarfelag">Sveitarf√©lag</label>
                                <input type="text" id="tengilidur1_sveitarfelag" name="tengilidur1_sveitarfelag" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tengilidur1_simi1">S√≠man√∫mer 1 <span class="required">*</span></label>
                                <input type="tel" id="tengilidur1_simi1" name="tengilidur1_simi1" placeholder="000-0000">
                            </div>
                            <div class="form-group">
                                <label for="tengilidur1_simi2">S√≠man√∫mer 2 <span class="optional">(valkv√¶tt)</span></label>
                                <input type="tel" id="tengilidur1_simi2" name="tengilidur1_simi2" placeholder="000-0000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tengilidur1_netfang">Netfang <span class="required">*</span></label>
                            <input type="email" id="tengilidur1_netfang" name="tengilidur1_netfang" placeholder="netfang@d√¶mi.is">
                        </div>

                        <div class="checkbox-item">
                            <input type="checkbox" id="tengilidur1_greidandi" name="tengilidur1_greidandi" checked>
                            <label for="tengilidur1_greidandi">√ûessi tengili√∞ur er grei√∞andi</label>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-add" id="btnAddContact" onclick="addContact()">+ B√¶ta vi√∞ tengili√∞ar</button>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Til baka</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(4)">√Åfram</button>
                </div>
            </div>

            <!-- Step 4: N√°msgrein -->
            <div class="form-step" data-step="4">
                <h2 class="step-title">N√°msgrein</h2>
                <p class="step-description">Veldu n√°msgrein. Deild √°kvar√∞ast sj√°lfkrafa.</p>

                <!-- Skilabo√∞ fyrir 1-2 √°ra -->
                <div class="info-box hidden" id="noCoursesMessage" style="border-left-color: var(--color-error);">
                    <p><strong>Ekkert n√°m er √≠ bo√∞i fyrir b√∂rn √° √æessum aldri.</strong></p>
                    <p>Vinsamlegast haf√∞u samband vi√∞ skrifstofu sk√≥lans √° <a href="mailto:tonak@tonak.is">tonak@tonak.is</a> e√∞a √≠ s√≠ma 460-1000 til a√∞ f√° frekari uppl√Ωsingar um bi√∞lista fyrir Suzukin√°m.</p>
                </div>

                <div class="form-group">
                    <label for="namsgrein">N√°msgrein / Hlj√≥√∞f√¶ri <span class="required">*</span></label>
                    <select id="namsgrein" name="namsgrein" onchange="updateDeild()">
                        <option value="">Veldu n√°msgrein...</option>
                        <!-- Options populated by JavaScript based on age -->
                    </select>
                </div>

                <div class="form-group" id="deildGroup" style="display: none;">
                    <label for="deild">Deild</label>
                    <input type="text" id="deild" name="deild" readonly disabled>
                </div>

                <!-- A√∞alfag - birtist a√∞eins √æegar Skapandi t√≥nlist er vali√∞ -->
                <div class="form-group hidden" id="adafagGroup">
                    <label for="adafag">A√∞alfag <span class="required">*</span></label>
                    <p class="field-description">Nemendur sem stunda n√°m √≠ skapandi t√≥nlist √æurfa a√∞ velja s√©r a√∞alfag sem √æau f√° einkat√≠ma √≠ hj√° umsj√≥narkennara/lei√∞beinanda s√≠num. H√©r getur √æ√∫ vali√∞ √æa√∞ sem √æ√∫ vilt leggja √°herslu √° √≠ n√°minu.</p>
                    <select id="adafag" name="adafag">
                        <option value="">Veldu a√∞alfag...</option>
                    </select>
                </div>

                <!-- Heilt/H√°lft n√°m -->
                <div class="form-group" id="namshlutiGroup">
                    <label>N√°mshlutfall</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="heiltNam" name="namshlutfall" value="heilt" checked>
                            <label for="heiltNam">Heilt n√°m</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="halftNam" name="namshlutfall" value="halft">
                            <label for="halftNam">H√°lft n√°m</label>
                        </div>
                    </div>
                </div>

                <!-- St√∫dentspr√≥fsbraut - only for 15+ -->
                <div class="form-group hidden" id="studentsprofGroup">
                    <div class="checkbox-item">
                        <input type="checkbox" id="studentsprof" name="studentsprof">
                        <label for="studentsprof">√âg s√¶ki um √° st√∫dentspr√≥fsbraut</label>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">Til baka</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(5)">√Åfram</button>
                </div>
            </div>

            <!-- Step 5: Sta√∞festing -->
            <div class="form-step" data-step="5">
                <h2 class="step-title">Sta√∞festing</h2>
                <p class="step-description">Vinsamlegast far√∞u yfir og sam√æykktu vi√∞skiptaskilm√°la.</p>

                <div class="terms-box">
                    <h4>Vi√∞skiptaskilm√°lar</h4>
                    <p>Gjaldskr√° sk√≥lans er h√°√∞ √°kv√∂r√∞unum b√¶jarsj√≥√∞s um gjaldskr√°rh√¶kkanir. T√≥nlistarsk√≥linn √° Akureyri √°skilur s√©r r√©tt til h√¶kkunar sk√≥la- og hlj√≥√∞f√¶raleigugjalda √° samningst√≠manum √≠ samr√¶mi vi√∞ √°kvar√∞anir b√¶jarsj√≥√∞s.</p>
                    <p>Sk√≥lagj√∂ld t√≥nlistarsk√≥lans eru greidd fyrir eina √∂nn √≠ einu en til hagr√¶√∞ingar fyrir grei√∞endur dreifast grei√∞slur sk√≥lagjalda √° 4 jafnar grei√∞slur fyrir hverja √∂nn me√∞ gjalddaga ca. 15. √°g., 15.sept., 15. okt., 15. n√≥v. fyrir haust√∂nn og gjalddaga 15. jan., 15. feb., 15. mars, 15. apr√≠l fyrir vor√∂nn.</p>
                    <p>Einungis er m√∂gulegt a√∞ segja upp samningi einu sinni √° √°ri, fr√° og me√∞ √°ram√≥tum og rennur uppsagnarfrestur fyrir vor√∂nn √∫t 1. n√≥vember √°r hvert. Til √æess a√∞ upps√∂gn s√© gild ver√∞ur a√∞ segja samningi upp skriflega me√∞ t√∂lvup√≥sti √° netfangi√∞ tonak@tonak.is.</p>
                    <p>Undantekning fr√° √æessu eru nemendur √≠ framhaldsn√°mi √° hlj√≥√∞f√¶ri og nemendur √≠ mi√∞ og framhaldsn√°mi √≠ s√∂ng. √ûessir nemendur geta ekki sagt upp n√°mi og sk√≥lavist √æeirra er bundin fyrir allt sk√≥la√°ri√∞ me√∞ √æessari ums√≥kn.</p>
                    <p>T√≥nlistarsk√≥linn √° Akureyri √°skilur s√©r birtingar- og dreifingarr√©tt √° √∂llu √æv√≠ hlj√≥√∞- og myndefni sem teki√∞ er upp af nemendum sk√≥lans √° vi√∞bur√∞um sem sk√≥linn stendur fyrir sem og √≠ kennslustundum.</p>
                    <p>Me√∞ √æv√≠ a√∞ senda inn ums√≥kn √≠ T√≥nlistarsk√≥lann √° Akureyri sam√æykkir ums√¶kjandi √æ√° skilm√°la sem birtast √≠ skjali √æessu sem og gjaldskr√° sk√≥lans og taka skilm√°larnir gildi strax og ums√¶kjandi hefur fengi√∞ sta√∞festingu √° n√°msvist.</p>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="samthykkiSkilmala" name="samthykkiSkilmala" required>
                        <label for="samthykkiSkilmala">√âg sam√æykki <strong>vi√∞skiptaskilm√°la</strong> T√≥nlistarsk√≥lans √° Akureyri <span class="required">*</span></label>
                    </div>

                    <div class="checkbox-item" id="fristundastyrksGroup">
                        <input type="checkbox" id="fristundastyrkur" name="fristundastyrkur">
                        <label for="fristundastyrkur">√âg √≥ska eftir a√∞ nota fr√≠stundastyrk <span class="optional">(6-18 √°ra)</span></label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="myndefni" name="myndefni">
                        <label for="myndefni">√âg sam√æykki a√∞ myndefni sem teki√∞ er upp af nemanda megi nota √° uppl√Ωsingas√≠√∞um sk√≥lans</label>
                    </div>

                    <div class="checkbox-item hidden" id="hljodfaraleiguGroup">
                        <input type="checkbox" id="hljodfaraleiga" name="hljodfaraleiga">
                        <label for="hljodfaraleiga">√âg √≥ska eftir hlj√≥√∞f√¶raleigu</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label for="athugasemd">Athugasemdir <span class="optional">(valkv√¶tt)</span></label>
                    <textarea id="athugasemd" name="athugasemd" rows="3" placeholder="H√©r getur √æ√∫ skrifa√∞ athugasemdir vi√∞ ums√≥knina ef √æ√∫ vilt..."></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(4)">Til baka</button>
                    <button type="button" class="btn btn-primary" id="btnSubmit" onclick="submitForm()">Senda ums√≥kn</button>
                </div>
            </div>

            <!-- Success -->
            <div class="form-step" data-step="success">
                <div class="success-message">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h2>Ums√≥kn m√≥ttekin!</h2>
                    <p>Takk fyrir ums√≥knina. Vi√∞ munum hafa samband vi√∞ √æig flj√≥tlega.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // GLOBAL STATE
        // =============================================
        let currentStep = 'start';
        let applicationMode = null; // 'new' or 'renewal'
        let studentAge = null;
        let studentAgeGroup = null;
        let studentBekkur = null;
        let contactCount = 1;
        let renewalStudentData = null; // Stores student data for renewal

        // =============================================
        // N√ÅMSGREINAR OG DEILDIR
        // Hver n√°msgrein hefur √°kve√∞na deild og aldurs-/bekkjarskilyr√∞i
        // hideNamshlutfall: true = ekki s√Ωna heilt/h√°lft n√°m val
        // needsDepartmentChoice: true = fag er √≠ bo√∞i √≠ b√¶√∞i klass√≠skri og rytm√≠skri deild
        // 
        // Aldursreglur:
        // - 0-1 √°rs: Kr√∫tt T√≥n√≥ einungis
        // - 1-2 √°ra: Ekkert √≠ bo√∞i (bi√∞listi)
        // - 3-5 √°ra: Suzuki einungis
        // - 1. bekkur: Forsk√≥li, Suzuki
        // - 2. bekkur: Forsk√≥li, Hringekja, Suzuki
        // - 3.-4. bekkur: Hringekja, Suzuki, √∂ll hlj√≥√∞f√¶ri (nema s√∂ngur og skapandi)
        // - 5.-10. bekkur: Barna- og unglingas√∂ngdeild (ef s√∂ngur), √∂ll hlj√≥√∞f√¶ri (nema skapandi)
        // - 15+ √°ra: Allt + Skapandi t√≥nlist
        // =============================================
        
        // F√∂g sem eru √≠ b√°√∞um deildum - √æarf a√∞ spyrja notanda
        const dualDepartmentSubjects = {
            'S√∂ngur': {
                question: 'Vilt √æ√∫ s√¶kja um klass√≠skan s√∂ng e√∞a jazz- og d√¶gurlagas√∂ng?',
                infoLink: 'https://www.tonak.is/is/hljodfaeri#songur',
                klassiskName: 'Klass√≠skur s√∂ngur',
                rytmiskName: 'D√¶gurs√∂ngur'
            },
            'Trommur': {
                question: 'Vilt √æ√∫ s√¶kja um hef√∞bundi√∞ trommu-/slagverksn√°m e√∞a trommur √≠ djass- og d√¶gurlagadeild?',
                infoLink: 'https://www.tonak.is/is/hljodfaeri#slagverk',
                klassiskName: 'Trommur og slagverk',
                rytmiskName: 'Trommur - Jazz og d√¶gurlagat√≥nlist'
            },
            'Kontrabassi': {
                question: 'Vilt √æ√∫ s√¶kja um klass√≠skt kontrabassan√°m e√∞a kontrabassa √≠ djass- og d√¶gurlagat√≥nlist?',
                infoLink: 'https://www.tonak.is/is/namid/afanganam',
                klassiskName: 'Kontrabassi',
                rytmiskName: 'Kontrabassi - Jazz og d√¶gurlagat√≥nlist'
            },
            'G√≠tar': {
                question: 'Vilt √æ√∫ s√¶kja um klass√≠skt g√≠tarn√°m e√∞a rafg√≠tarn√°m?',
                infoLink: 'https://www.tonak.is/is/hljodfaeri#gitar',
                klassiskName: 'G√≠tar',
                rytmiskName: 'G√≠tar - Rafg√≠tar'
            },
            'Sax√≥f√≥nn': {
                question: 'Vilt √æ√∫ s√¶kja um klass√≠skt sax√≥f√≥nn√°m e√∞a n√°m √≠ jazz- og d√¶gurlagadeild?',
                infoLink: 'https://www.tonak.is/is/namid/afanganam',
                klassiskName: 'Sax√≥f√≥nn',
                rytmiskName: 'Sax√≥f√≥nn - Jazz og d√¶gurlagat√≥nlist'
            },
            'P√≠an√≥': {
                question: 'Vilt √æ√∫ s√¶kja um klass√≠skt p√≠an√≥n√°m e√∞a p√≠an√≥n√°m √≠ djass- og d√¶gurlagat√≥nlist?',
                infoLink: 'https://www.tonak.is/is/namid/afanganam',
                klassiskName: 'P√≠an√≥',
                rytmiskName: 'P√≠an√≥ - d√¶gurlagat√≥nlist'
            }
        };
        
        const namsgreinar = [
            // Kr√∫tt T√≥n√≥ - Ungbarnat√≥nlist (0-1 √°rs)
            { name: 'Kr√∫tt T√≥n√≥ - Ungbarnat√≥nlist', deild: 'Forsk√≥ladeild', minAgeMonths: 0, maxAgeMonths: 23, useMonths: true, hideNamshlutfall: true },
            
            // Forsk√≥li (1.-2. bekkur, √æ.e. 6-7 √°ra)
            { name: 'Forsk√≥li', deild: 'Forsk√≥ladeild', minBekkur: 1, maxBekkur: 2, useBekkur: true, hideNamshlutfall: true },
            
            // Hringekja (2.-4. bekkur, √æ.e. 7-9 √°ra)
            { name: 'Hringekja', deild: 'Forsk√≥ladeild', minBekkur: 2, maxBekkur: 4, useBekkur: true, hideNamshlutfall: true },
            
            // Suzuki deild (3 √°ra og eldri)
            { name: 'Suzukifi√∞la', deild: 'Suzuki deild', minAge: 3, maxAge: 99, hideNamshlutfall: true },
            { name: 'Suzukikontrabass', deild: 'Suzuki deild', minAge: 3, maxAge: 99, hideNamshlutfall: true },
            { name: 'Suzuk√≠p√≠an√≥', deild: 'Suzuki deild', minAge: 3, maxAge: 99, hideNamshlutfall: true },
            { name: 'Suzukisell√≥', deild: 'Suzuki deild', minAge: 3, maxAge: 99, hideNamshlutfall: true },
            { name: 'Suzukivi√≥la', deild: 'Suzuki deild', minAge: 3, maxAge: 99, hideNamshlutfall: true },
            
            // Barna- og unglingas√∂ngdeild (5.-10. bekkur fyrir s√∂ng)
            { name: 'Barna- og unglingas√∂ngdeild', deild: 'Barna- og unglingas√∂ngdeild', minBekkur: 5, maxBekkur: 10, useBekkur: true, isSongur: true },
            
            // F√∂g sem eru √≠ b√°√∞um deildum - s√Ωna eitt nafn, spyrja um deild
            { name: 'S√∂ngur', deild: null, minAge: 15, maxAge: 99, needsDepartmentChoice: true },
            { name: 'Trommur', deild: null, minBekkur: 3, maxBekkur: 99, useBekkur: true, needsDepartmentChoice: true },
            { name: 'Kontrabassi', deild: null, minBekkur: 3, maxBekkur: 99, useBekkur: true, needsDepartmentChoice: true },
            { name: 'G√≠tar', deild: null, minBekkur: 3, maxBekkur: 99, useBekkur: true, needsDepartmentChoice: true },
            { name: 'Sax√≥f√≥nn', deild: null, minBekkur: 3, maxBekkur: 99, useBekkur: true, needsDepartmentChoice: true },
            { name: 'P√≠an√≥', deild: null, minBekkur: 3, maxBekkur: 99, useBekkur: true, needsDepartmentChoice: true },
            
            // Klass√≠sk deild - hlj√≥√∞f√¶ri sem eru EING√ñNGU klass√≠sk (fr√° 3. bekk / 8 √°ra)
            { name: 'Alt horn', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Altflauta', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Bar√≠t√≥nhorn', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'B√°s√∫na', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Fi√∞la', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Franskt horn', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Harm√≥nika', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Klarinetta', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Kornett', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Orgel', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: '√ìb√≥', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Sell√≥', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'Trompet', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'T√∫ba', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: 'V√≠√≥la', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            { name: '√ûverflauta', deild: 'Klass√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            
            // Rytm√≠sk deild - hlj√≥√∞f√¶ri sem eru EING√ñNGU rytm√≠sk (fr√° 3. bekk / 8 √°ra)
            { name: 'Rafbassi', deild: 'Rytm√≠sk deild', minBekkur: 3, maxBekkur: 99, useBekkur: true },
            
            // Skapandi t√≥nlist (15 √°ra og eldri - framhaldssk√≥laaldur) - ein n√°msgrein
            { name: 'Skapandi t√≥nlist', deild: 'Skapandi t√≥nlist', minAge: 15, maxAge: 99, hideNamshlutfall: true, needsAdafag: true }
        ];
        
        // A√∞alf√∂g fyrir Skapandi t√≥nlist
        const adafogSkapandiTonlist = [
            // Klass√≠sk deild
            'Alt horn',
            'Altflauta',
            'Bar√≠t√≥nhorn',
            'B√°s√∫na',
            'Fi√∞la',
            'Franskt horn',
            'G√≠tar',
            'Harm√≥nika',
            'Klarinetta',
            'Klass√≠skur s√∂ngur',
            'Kontrabassi',
            'Kornett',
            'Orgel',
            '√ìb√≥',
            'P√≠an√≥',
            'Sax√≥f√≥nn',
            'Sell√≥',
            'Trommur og slagverk',
            'Trompet',
            'T√∫ba',
            'V√≠√≥la',
            '√ûverflauta',
            // Rytm√≠sk deild
            'D√¶gurs√∂ngur',
            'G√≠tar - Rafg√≠tar',
            'P√≠an√≥ - d√¶gurlagat√≥nlist',
            'Rafbassi',
            'Trommur - Jazz og d√¶gurlagat√≥nlist',
            'Sax√≥f√≥nn - Jazz og d√¶gurlagat√≥nlist',
            'Kontrabassi - Jazz og d√¶gurlagat√≥nlist',
            // S√©rstakt fyrir Skapandi t√≥nlist
            'Hlj√≥√∞vinnsla og t√≥nlistarsk√∂pun'
        ];
        
        // Hlj√≥√∞f√¶ri sem h√¶gt er a√∞ leigja
        const hljodfariFyrirLeigu = [
            'V√≠√≥la',
            'Alt horn',
            'Altflauta',
            'Bar√≠t√≥nhorn',
            'B√°s√∫na',
            'Fi√∞la',
            'Franskt horn',
            'Harm√≥nika',
            'Klarinetta',
            'Kornett',
            '√ìb√≥',
            'Sell√≥',
            'T√∫ba',
            'Sax√≥f√≥nn',
            '√ûverflauta',
            'Kontrabassi',
            'Rafbassi',
            'Suzukifi√∞la',
            'Suzukikontrabass',
            'Suzukisell√≥',
            'Suzukivi√≥la',
            // Einnig rytm√≠sk √∫tg√°fa
            'Sax√≥f√≥nn - Jazz og d√¶gurlagat√≥nlist',
            'Kontrabassi - Jazz og d√¶gurlagat√≥nlist'
        ];
        
        // Sk√≥lalistar
        const grunnskolar = [
            'Lundarsk√≥li',
            'Giljask√≥li',
            'Brekkusk√≥li',
            'Naustask√≥li',
            'S√≠√∞usk√≥li',
            'Gler√°rsk√≥li',
            'Oddeyrarsk√≥li',
            'Hl√≠√∞arsk√≥li',
            'Anna√∞'
        ];
        
        const framhaldsskolar = [
            'Menntask√≥linn √° Akureyri',
            'Verkmenntask√≥linn √° Akureyri',
            'Framhaldssk√≥linn √° H√∫sav√≠k',
            'Framhaldssk√≥linn √° Laugum',
            'Menntask√≥linn √° Tr√∂llaskaga',
            'Er ekki √≠ framhaldssk√≥la',
            'Anna√∞'
        ];

        // =============================================
        // ALDURS√öTREIKNINGUR √öR KENNIT√ñLU
        // =============================================
        function parseKennitala(kt) {
            if (!kt || kt.length !== 10 || !/^\d{10}$/.test(kt)) {
                return null;
            }

            const day = parseInt(kt.substring(0, 2));
            const month = parseInt(kt.substring(2, 4));
            const yearShort = parseInt(kt.substring(4, 6));
            const centuryDigit = parseInt(kt.substring(9, 10));

            let century;
            if (centuryDigit === 0) {
                century = 2000;
            } else if (centuryDigit === 9) {
                century = 1900;
            } else if (centuryDigit === 8) {
                century = 1800;
            } else {
                return null; // √ìgild kennitala
            }

            const year = century + yearShort;
            
            // Athuga hvort dagsetning s√© gild
            const birthDate = new Date(year, month - 1, day);
            if (birthDate.getDate() !== day || birthDate.getMonth() !== month - 1) {
                return null;
            }

            return {
                day,
                month,
                year,
                birthDate
            };
        }

        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function calculateAgeAtEndOfYear(birthDate) {
            const currentYear = new Date().getFullYear();
            return currentYear - birthDate.getFullYear();
        }

        function getAgeGroup(birthDate) {
            const exactAge = calculateAge(birthDate);
            const ageAtEndOfYear = calculateAgeAtEndOfYear(birthDate);
            
            // 18+ mi√∞ast vi√∞ n√°kv√¶man aldur (fr√° afm√¶lisdegi)
            if (exactAge >= 18) {
                return { group: '18+', label: '18 √°ra og eldri', minors: false };
            }
            
            // Yngri aldursh√≥par mi√∞ast vi√∞ almanaks√°r
            if (ageAtEndOfYear >= 16) {
                return { group: '16-17', label: '16-17 √°ra', minors: true };
            }
            
            if (ageAtEndOfYear >= 6) {
                return { group: '6-15', label: '6-15 √°ra (grunnsk√≥laaldur)', minors: true };
            }
            
            return { group: '0-5', label: '0-5 √°ra (forsk√≥laaldur)', minors: true };
        }
        
        // Reikna bekk √∫t fr√° f√¶√∞ingar√°ri
        // B√∂rn f√¶dd √°ri√∞ X hefja n√°m √≠ 1. bekk √æegar √æau ver√∞a 6 √°ra √° almanaks√°rinu
        function calculateBekkur(birthDate) {
            const currentYear = new Date().getFullYear();
            const birthYear = birthDate.getFullYear();
            const ageAtEndOfYear = currentYear - birthYear;
            
            // Ef yngri en 6 √°ra √° √°rinu ‚Üí ekki byrja√∞ √≠ grunnsk√≥la
            if (ageAtEndOfYear < 6) {
                return 0; // Ekki √≠ grunnsk√≥la
            }
            
            // Bekkur = aldur √° √°rinu - 5
            // 6 √°ra = 1. bekkur, 7 √°ra = 2. bekkur, osfrv.
            const bekkur = ageAtEndOfYear - 5;
            
            // Ef eldri en 10. bekkur (15 √°ra+) ‚Üí framhaldssk√≥laaldur
            if (bekkur > 10) {
                return 11; // Merkir framhaldssk√≥laaldur
            }
            
            return bekkur;
        }
        
        // Reikna aldur √≠ m√°nu√∞um (fyrir ungbarnat√≥nlist)
        function calculateAgeInMonths(birthDate) {
            const today = new Date();
            const months = (today.getFullYear() - birthDate.getFullYear()) * 12;
            return months + today.getMonth() - birthDate.getMonth();
        }
        
        // Athuga hvort n√°msgrein s√© √≠ bo√∞i fyrir nemanda
        function isNamsgreinAvailable(namsgrein, birthDate) {
            const exactAge = calculateAge(birthDate);
            const ageAtEndOfYear = calculateAgeAtEndOfYear(birthDate);
            const bekkur = calculateBekkur(birthDate);
            const ageInMonths = calculateAgeInMonths(birthDate);
            
            // Ef n√°msgrein notar m√°na√∞aaldur (ungbarnat√≥nlist)
            if (namsgrein.useMonths) {
                return ageInMonths >= namsgrein.minAgeMonths && ageInMonths <= namsgrein.maxAgeMonths;
            }
            
            // Ef n√°msgrein notar bekk
            if (namsgrein.useBekkur) {
                return bekkur >= namsgrein.minBekkur && bekkur <= namsgrein.maxBekkur;
            }
            
            // Annars notar aldur
            return ageAtEndOfYear >= namsgrein.minAge && ageAtEndOfYear <= namsgrein.maxAge;
        }
        
        // Athuga hvort ekkert n√°m s√© √≠ bo√∞i (1-2 √°ra)
        function isNoCoursesAvailable(birthDate) {
            const ageInMonths = calculateAgeInMonths(birthDate);
            // 12-35 m√°na√∞a = 1-2 √°ra, ekkert √≠ bo√∞i
            return ageInMonths >= 12 && ageInMonths < 36;
        }

        // =============================================
        // START SCREEN AND NAVIGATION
        // =============================================
        function goToStart() {
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            
            // Show start screen
            document.querySelector('.form-step[data-step="start"]').classList.add('active');
            
            // Hide progress
            document.getElementById('progressContainer').style.display = 'none';
            
            currentStep = 'start';
            applicationMode = null;
        }

        function startNewApplication() {
            applicationMode = 'new';
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            
            // Go to step 1
            goToStep(1);
        }

        function startRenewal() {
            applicationMode = 'renewal';
            
            // Hide progress for renewal flow
            document.getElementById('progressContainer').style.display = 'none';
            
            // Go to renewal step 1
            goToStep('renewal-1');
        }

        // =============================================
        // √ûJ√ì√êSKR√Å INTEGRATION
        // =============================================
        function fetchFromThjodskra(kennitala) {
            const thjodskraUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/18399dc2b5994d608dcdbe6fcdd77bf9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Nd7sld9BgrFbjqkrX5JziBDTfVN8aKi2DNn-SB3e8nc';
            
            // S√Ωna loading
            const nafnInput = document.getElementById('nafn');
            const logheimiliInput = document.getElementById('logheimili');
            const sveitarfelagInput = document.getElementById('sveitarfelag');
            
            if (nafnInput) nafnInput.placeholder = 'S√¶ki √∫r √ûj√≥√∞skr√°...';
            
            fetch(thjodskraUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kennitala: kennitala })
            })
            .then(response => response.json())
            .then(data => {
                console.log('√ûj√≥√∞skr√° response:', data);
                
                if (data.retkod === '0' || data.retkod === 0) {
                    // T√≥kst - fylla inn uppl√Ωsingar
                    if (nafnInput && data.nafn) {
                        nafnInput.value = data.nafn;
                    }
                    if (logheimiliInput && data.heimili) {
                        logheimiliInput.value = data.heimili;
                    }
                    if (sveitarfelagInput && data.sveitarfelag) {
                        // Sameina postn√∫mer og sveitarf√©lag
                        const postnr = data.postnr || '';
                        const sveitarfelag = data.sveitarfelag || '';
                        sveitarfelagInput.value = postnr ? `${postnr} ${sveitarfelag}` : sveitarfelag;
                    }
                    
                    // Fylla l√≠ka √≠ postnumer reit ef hann er til
                    const postnumerInput = document.getElementById('postnumer');
                    if (postnumerInput && data.postnr) {
                        postnumerInput.value = data.postnr;
                    }
                } else {
                    console.log('√ûj√≥√∞skr√° villa:', data.retlys);
                    if (nafnInput) nafnInput.placeholder = 'Nafn';
                }
            })
            .catch(error => {
                console.error('√ûj√≥√∞skr√° error:', error);
                if (nafnInput) nafnInput.placeholder = 'Nafn';
            });
        }
        
        function fetchTengilidarFromThjodskra(kennitala, tengilidarNumer) {
            const thjodskraUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/18399dc2b5994d608dcdbe6fcdd77bf9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Nd7sld9BgrFbjqkrX5JziBDTfVN8aKi2DNn-SB3e8nc';
            
            const prefix = `tengilidur${tengilidarNumer}_`;
            
            // S√Ωna loading
            const nafnInput = document.getElementById(prefix + 'nafn');
            if (nafnInput) nafnInput.placeholder = 'S√¶ki √∫r √ûj√≥√∞skr√°...';
            
            fetch(thjodskraUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kennitala: kennitala })
            })
            .then(response => response.json())
            .then(data => {
                console.log(`√ûj√≥√∞skr√° response (tengili√∞ur ${tengilidarNumer}):`, data);
                
                if (data.retkod === '0' || data.retkod === 0) {
                    // T√≥kst - fylla inn uppl√Ωsingar
                    if (nafnInput && data.nafn) {
                        nafnInput.value = data.nafn;
                    }
                    
                    const heimiliInput = document.getElementById(prefix + 'heimili');
                    if (heimiliInput && data.heimili) {
                        heimiliInput.value = data.heimili;
                    }
                    
                    const postnumerInput = document.getElementById(prefix + 'postnumer');
                    if (postnumerInput && data.postnr) {
                        postnumerInput.value = data.postnr;
                    }
                    
                    const sveitarfelagInput = document.getElementById(prefix + 'sveitarfelag');
                    if (sveitarfelagInput && data.sveitarfelag) {
                        sveitarfelagInput.value = data.sveitarfelag;
                    }
                } else {
                    console.log(`√ûj√≥√∞skr√° villa (tengili√∞ur ${tengilidarNumer}):`, data.retlys);
                    if (nafnInput) nafnInput.placeholder = 'Nafn fannst ekki';
                }
            })
            .catch(error => {
                console.error(`√ûj√≥√∞skr√° error (tengili√∞ur ${tengilidarNumer}):`, error);
                if (nafnInput) nafnInput.placeholder = 'Villa vi√∞ leit';
            });
        }

        function searchForRenewal() {
            const kt = document.getElementById('renewalKennitala').value;
            const notFoundMessage = document.getElementById('renewalNotFound');
            const searchBtn = document.getElementById('btnSearchRenewal');
            
            // Disable button while searching
            searchBtn.disabled = true;
            searchBtn.textContent = 'Leita...';
            
            // Power Automate URL for TA-CheckKennitala
            const checkKennitalaUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/769a62a47d8247ae88a1b24a50650bfd/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=0Zj9fqOg6hOHJ29j-VQTQIZRntS7NBEyBf7Qn9-Ni2w';
            
            fetch(checkKennitalaUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kennitala: kt })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Check kennitala response:', data);
                
                if (data.exists && data.student) {
                    // Student found - store data
                    renewalStudentData = {
                        id: data.student.ID || data.student.Id,
                        kennitala: kt,
                        nafn: data.student.Nafn || data.student.Title || '√ì√æekkt',
                        namsgrein: data.student.Namsgrein || '√ì√æekkt'
                    };
                    
                    // Update display
                    document.getElementById('renewalStudentName').textContent = renewalStudentData.nafn;
                    document.getElementById('renewalStudentSubject').textContent = renewalStudentData.namsgrein;
                    
                    notFoundMessage.classList.add('hidden');
                    goToStep('renewal-2');
                } else {
                    // Student not found
                    notFoundMessage.classList.remove('hidden');
                }
                
                // Re-enable button
                searchBtn.disabled = false;
                searchBtn.textContent = 'Leita';
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationError('Villa kom upp vi√∞ leit. Vinsamlegast reyndu aftur.');
                
                // Re-enable button
                searchBtn.disabled = false;
                searchBtn.textContent = 'Leita';
            });
        }

        function confirmRenewal() {
            goToStep('renewal-confirm');
        }

        function requestChanges() {
            goToStep('renewal-changes');
        }

        function submitRenewal() {
            const email = document.getElementById('renewalEmail').value;
            const notes = document.getElementById('renewalNotes').value;
            const terms = document.getElementById('renewalSamthykkiSkilmala').checked;
            
            let errors = [];
            
            if (!terms) {
                errors.push('‚Ä¢ √û√∫ ver√∞ur a√∞ sam√æykkja vi√∞skiptaskilm√°la');
            }
            if (!email.trim()) {
                errors.push('‚Ä¢ Netfang fyrir sta√∞festingu er nau√∞synlegt');
            } else if (!isValidEmail(email)) {
                errors.push('‚Ä¢ Netfang er ekki √° r√©ttu formi (d√¶mi: nafn@d√¶mi.is)');
            }
            
            if (errors.length > 0) {
                showValidationError('Vinsamlegast lagf√¶r√∞u eftirfarandi:\n\n' + errors.join('\n'));
                return;
            }
            
            // Disable button
            const submitBtn = document.querySelector('.form-step[data-step="renewal-confirm"] .btn-primary');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sendi ums√≥kn...';
            }
            
            const formData = {
                kennitala: renewalStudentData.kennitala,
                nafn: renewalStudentData.nafn,
                tegund: 'Endurn√Ωjun',
                namsgrein: renewalStudentData.namsgrein || '',
                deild: '',
                namshlutfall: '',
                studentsprof: false,
                skoli: '',
                fristundastyrkur: document.getElementById('renewalFristundastyrkur')?.checked || false,
                hljodfaraleiga: document.getElementById('renewalHljodfaraleiga')?.checked || false,
                myndefni: document.getElementById('renewalMyndefni')?.checked || false,
                netfangNemanda: email,
                simiNemanda: '',
                athugasemdNemanda: notes,
                adafagSkapandi: '',
                tengili√∞ur1Nafn: '',
                tengili√∞ur1Kennitala: '',
                tengili√∞ur1Simi: '',
                tengili√∞ur1Netfang: '',
                tengili√∞ur1Greidandi: false,
                tengili√∞ur2Nafn: '',
                tengili√∞ur2Kennitala: '',
                tengili√∞ur2Simi: '',
                tengili√∞ur2Netfang: '',
                tengili√∞ur2Greidandi: false
            };
            
            // Power Automate URL
            const powerAutomateUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1b59cccd3fd64e189663b60d6d1697a1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9mYPS9IyuTu1fncoIQt1ZR-ErOOV_SWAE5fWZshW1xc';
            
            fetch(powerAutomateUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) throw new Error('Villa vi√∞ a√∞ senda ums√≥kn');
                return response.json();
            })
            .then(data => {
                console.log('Renewal success:', data);
                goToStep('success');
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationError('Villa kom upp vi√∞ a√∞ senda ums√≥kn. Vinsamlegast reyndu aftur.');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Senda ums√≥kn';
                }
            });
        }

        function submitChangeRequest() {
            const email = document.getElementById('changeEmail').value;
            const notes = document.getElementById('changeNotes').value;
            const terms = document.getElementById('changeSamthykkiSkilmala').checked;
            
            const changes = [];
            if (document.getElementById('changeInstrument').checked) changes.push('Skipta um hlj√≥√∞f√¶ri');
            if (document.getElementById('changeTeacher').checked) changes.push('Skipta um kennara');
            if (document.getElementById('changeRatio').checked) changes.push('Breyta n√°mshlutfalli');
            if (document.getElementById('changeOther').checked) changes.push('Anna√∞');
            
            // Validation with specific messages
            let errors = [];
            
            if (changes.length === 0) {
                errors.push('‚Ä¢ Veldu a√∞ minnsta kosti eina tegund breytingar');
            }
            if (!notes.trim()) {
                errors.push('‚Ä¢ L√Ωsing √° breytingum er nau√∞synleg');
            }
            if (!terms) {
                errors.push('‚Ä¢ √û√∫ ver√∞ur a√∞ sam√æykkja vi√∞skiptaskilm√°la');
            }
            if (!email.trim()) {
                errors.push('‚Ä¢ Netfang fyrir sta√∞festingu er nau√∞synlegt');
            } else if (!isValidEmail(email)) {
                errors.push('‚Ä¢ Netfang er ekki √° r√©ttu formi (d√¶mi: nafn@d√¶mi.is)');
            }
            
            if (errors.length > 0) {
                showValidationError('Vinsamlegast lagf√¶r√∞u eftirfarandi:\n\n' + errors.join('\n'));
                return;
            }
            
            // Disable button
            const submitBtn = document.querySelector('.form-step[data-step="renewal-changes"] .btn-primary');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sendi ums√≥kn...';
            }
            
            // Combine changes and notes
            const fullNotes = '√ìska√∞ eftir breytingum: ' + changes.join(', ') + '\n\nL√Ωsing: ' + notes;
            
            const formData = {
                kennitala: renewalStudentData.kennitala,
                nafn: renewalStudentData.nafn,
                tegund: 'Breyting',
                namsgrein: renewalStudentData.namsgrein || '',
                deild: '',
                namshlutfall: '',
                studentsprof: false,
                skoli: '',
                fristundastyrkur: document.getElementById('changeFristundastyrkur')?.checked || false,
                hljodfaraleiga: document.getElementById('changeHljodfaraleiga')?.checked || false,
                myndefni: document.getElementById('changeMyndefni')?.checked || false,
                netfangNemanda: email,
                simiNemanda: '',
                athugasemdNemanda: fullNotes,
                adafagSkapandi: '',
                tengili√∞ur1Nafn: '',
                tengili√∞ur1Kennitala: '',
                tengili√∞ur1Simi: '',
                tengili√∞ur1Netfang: '',
                tengili√∞ur1Greidandi: false,
                tengili√∞ur2Nafn: '',
                tengili√∞ur2Kennitala: '',
                tengili√∞ur2Simi: '',
                tengili√∞ur2Netfang: '',
                tengili√∞ur2Greidandi: false
            };
            
            // Power Automate URL
            const powerAutomateUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1b59cccd3fd64e189663b60d6d1697a1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9mYPS9IyuTu1fncoIQt1ZR-ErOOV_SWAE5fWZshW1xc';
            
            fetch(powerAutomateUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) throw new Error('Villa vi√∞ a√∞ senda ums√≥kn');
                return response.json();
            })
            .then(data => {
                console.log('Change request success:', data);
                goToStep('success');
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationError('Villa kom upp vi√∞ a√∞ senda ums√≥kn. Vinsamlegast reyndu aftur.');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Senda ums√≥kn';
                }
            });
        }

        // =============================================
        // FORM NAVIGATION
        // =============================================
        function goToStep(step) {
            // Handle renewal steps (strings) vs new application steps (numbers)
            const isRenewalStep = typeof step === 'string' && step.startsWith('renewal');
            const isSuccessStep = step === 'success';
            
            // Validate current step before moving forward (only for new applications)
            if (applicationMode === 'new' && typeof step === 'number' && typeof currentStep === 'number') {
                if (step > currentStep && !validateStep(currentStep)) {
                    return;
                }
            }

            // Hide current step
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            
            // Show new step
            const newStepEl = document.querySelector(`.form-step[data-step="${step}"]`);
            if (newStepEl) {
                newStepEl.classList.add('active');
            }
            
            currentStep = step;
            
            // Update progress (only for new applications)
            if (applicationMode === 'new' && typeof step === 'number') {
                updateProgress();
                updateStepContent();
            }
            
            // Show/hide progress container
            if (isRenewalStep || step === 'start') {
                document.getElementById('progressContainer').style.display = 'none';
            } else if (applicationMode === 'new' && typeof step === 'number') {
                document.getElementById('progressContainer').style.display = 'block';
            }
            
            // Handle success step
            if (isSuccessStep) {
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        function updateProgress() {
            const indicators = document.querySelectorAll('.step-indicator');
            const labels = document.querySelectorAll('.step-label');
            const progressLine = document.getElementById('progressLine');
            
            indicators.forEach((ind, idx) => {
                const stepNum = idx + 1;
                ind.classList.remove('active', 'completed');
                labels[idx].classList.remove('active');
                
                if (stepNum < currentStep) {
                    ind.classList.add('completed');
                    ind.innerHTML = '‚úì';
                } else if (stepNum === currentStep) {
                    ind.classList.add('active');
                    ind.innerHTML = stepNum;
                    labels[idx].classList.add('active');
                } else {
                    ind.innerHTML = stepNum;
                }
            });

            // Update progress line
            const progress = ((currentStep - 1) / 4) * 100;
            progressLine.style.width = `${progress}%`;
        }

        function updateStepContent() {
            // Update step 2: Show/hide school field based on age and populate dropdown
            const skoliSection = document.getElementById('skoliSection');
            const skoliLabel = document.getElementById('skoliLabel');
            const studentsprofInStep2 = document.getElementById('studentsprofStep2Group');
            
            if (studentBekkur !== null || studentAge !== null) {
                if (studentBekkur >= 1 && studentBekkur <= 10) {
                    // Grunnsk√≥laaldur (6-15 √°ra)
                    skoliSection.classList.remove('hidden');
                    skoliLabel.textContent = 'Grunnsk√≥li';
                    if (studentsprofInStep2) studentsprofInStep2.classList.add('hidden');
                    populateSkolar();
                } else if (studentAge >= 15 && studentAge <= 24) {
                    // Framhaldssk√≥laaldur (15-24 √°ra)
                    skoliSection.classList.remove('hidden');
                    skoliLabel.textContent = 'Framhaldssk√≥li';
                    if (studentsprofInStep2) studentsprofInStep2.classList.remove('hidden');
                    populateSkolar();
                } else {
                    // Yngri en 6 √°ra e√∞a eldri en 24 √°ra
                    skoliSection.classList.add('hidden');
                    if (studentsprofInStep2) studentsprofInStep2.classList.add('hidden');
                }
            }

            // Update step 3: Show appropriate contact section
            const selfContactInfo = document.getElementById('selfContactInfo');
            const contactsContainer = document.getElementById('contactsContainer');
            const btnAddContact = document.getElementById('btnAddContact');
            const contactDescription = document.getElementById('contactDescription');

            if (studentAgeGroup && !studentAgeGroup.minors) {
                // 18+ - nemandi er sj√°lfur tengili√∞ur
                selfContactInfo.classList.remove('hidden');
                contactsContainer.classList.add('hidden');
                btnAddContact.classList.add('hidden');
                contactDescription.textContent = '√ûar sem √æ√∫ ert 18 √°ra e√∞a eldri ertu sj√°lfur tengili√∞ur og grei√∞andi.';
            } else {
                selfContactInfo.classList.add('hidden');
                contactsContainer.classList.remove('hidden');
                btnAddContact.classList.remove('hidden');
                contactDescription.textContent = 'Vinsamlegast skr√°√∞u uppl√Ωsingar um forr√°√∞amann/forr√°√∞amenn.';
            }

            // Update step 4: Populate n√°msgreinar based on age
            if (currentStep === 4) {
                populateNamsgreinar();
            }

            // Hide st√∫dentspr√≥fsbraut in step 4 (moved to step 2)
            const studentsprofGroup = document.getElementById('studentsprofGroup');
            if (studentsprofGroup) {
                studentsprofGroup.classList.add('hidden');
            }
            
            // Update step 5: Show/hide fr√≠stundastyrk based on age (6-18 √°ra)
            const fristundastyrksGroup = document.getElementById('fristundastyrksGroup');
            if (fristundastyrksGroup) {
                if (studentAge >= 6 && studentAge < 18) {
                    fristundastyrksGroup.classList.remove('hidden');
                } else {
                    fristundastyrksGroup.classList.add('hidden');
                    // Uncheck if hidden
                    document.getElementById('fristundastyrkur').checked = false;
                }
            }
        }

        // =============================================
        // DEILDIR OG N√ÅMSGREINAR
        // =============================================
        function populateNamsgreinar() {
            const namsgreinSelect = document.getElementById('namsgrein');
            const ktValue = document.getElementById('kennitala').value;
            const parsed = parseKennitala(ktValue);
            const noCoursesMessage = document.getElementById('noCoursesMessage');
            const namshlutiGroup = document.getElementById('namshlutiGroup');
            
            if (!parsed) return;
            
            namsgreinSelect.innerHTML = '<option value="">Veldu n√°msgrein...</option>';
            
            // Athuga hvort ekkert n√°m s√© √≠ bo√∞i (1-2 √°ra)
            if (isNoCoursesAvailable(parsed.birthDate)) {
                namsgreinSelect.innerHTML = '<option value="">Ekkert n√°m √≠ bo√∞i</option>';
                namsgreinSelect.disabled = true;
                if (noCoursesMessage) {
                    noCoursesMessage.classList.remove('hidden');
                }
                document.getElementById('deild').value = '';
                document.getElementById('deildGroup').style.display = 'none';
                namshlutiGroup.classList.add('hidden');
                return;
            }
            
            namsgreinSelect.disabled = false;
            if (noCoursesMessage) {
                noCoursesMessage.classList.add('hidden');
            }
            
            // Filter n√°msgreinar by age/bekkur
            const filtered = namsgreinar
                .filter(n => isNamsgreinAvailable(n, parsed.birthDate))
                .sort((a, b) => a.name.localeCompare(b.name, 'is'));
            
            filtered.forEach(namsgrein => {
                const option = document.createElement('option');
                option.value = namsgrein.name;
                option.textContent = namsgrein.name;
                option.dataset.deild = namsgrein.deild || '';
                option.dataset.hideNamshlutfall = namsgrein.hideNamshlutfall ? 'true' : 'false';
                option.dataset.needsDepartmentChoice = namsgrein.needsDepartmentChoice ? 'true' : 'false';
                namsgreinSelect.appendChild(option);
            });
            
            // Athuga hvort √∂ll f√∂g √≠ bo√∞i eru me√∞ hideNamshlutfall
            const allHideNamshlutfall = filtered.every(n => n.hideNamshlutfall === true);
            if (allHideNamshlutfall) {
                namshlutiGroup.classList.add('hidden');
            } else {
                namshlutiGroup.classList.remove('hidden');
            }
            
            // Reset deild
            document.getElementById('deild').value = '';
            document.getElementById('deildGroup').style.display = 'none';
        }

        function updateDeild() {
            const namsgreinSelect = document.getElementById('namsgrein');
            const selectedOption = namsgreinSelect.options[namsgreinSelect.selectedIndex];
            const deildInput = document.getElementById('deild');
            const deildGroup = document.getElementById('deildGroup');
            const namshlutiGroup = document.getElementById('namshlutiGroup');
            const adafagGroup = document.getElementById('adafagGroup');
            const selectedName = selectedOption ? selectedOption.value : '';
            
            // Athuga hvort √æetta fag √æurfi deildarval
            if (selectedName && dualDepartmentSubjects[selectedName]) {
                showDepartmentChoiceModal(selectedName);
                // Fela a√∞alfagsval
                adafagGroup.classList.add('hidden');
                return;
            }
            
            // Athuga hvort √æetta er Skapandi t√≥nlist (√æarf a√∞alfagsval)
            if (selectedName === 'Skapandi t√≥nlist') {
                deildInput.value = 'Skapandi t√≥nlist';
                deildGroup.style.display = 'block';
                namshlutiGroup.classList.add('hidden');
                
                // S√Ωna og fylla a√∞alfagsval
                adafagGroup.classList.remove('hidden');
                populateAdafagSelect();
            } else {
                // Fela a√∞alfagsval
                adafagGroup.classList.add('hidden');
                
                if (selectedOption && selectedOption.dataset.deild) {
                    deildInput.value = selectedOption.dataset.deild;
                    deildGroup.style.display = 'block';
                    
                    // S√Ωna/fela n√°mshlutfall eftir n√°msgrein
                    if (selectedOption.dataset.hideNamshlutfall === 'true') {
                        namshlutiGroup.classList.add('hidden');
                    } else {
                        namshlutiGroup.classList.remove('hidden');
                    }
                } else {
                    deildInput.value = '';
                    deildGroup.style.display = 'none';
                    namshlutiGroup.classList.remove('hidden');
                }
            }
            
            // Uppf√¶ra hlj√≥√∞f√¶raleigu s√Ωnileika
            updateHljodfaraleigaVisibility();
        }
        
        function populateAdafagSelect() {
            const adafagSelect = document.getElementById('adafag');
            adafagSelect.innerHTML = '<option value="">Veldu a√∞alfag...</option>';
            
            adafogSkapandiTonlist.forEach(fag => {
                const option = document.createElement('option');
                option.value = fag;
                option.textContent = fag;
                adafagSelect.appendChild(option);
            });
        }
        
        function updateHljodfaraleigaVisibility() {
            const namsgreinSelect = document.getElementById('namsgrein');
            const selectedOption = namsgreinSelect.options[namsgreinSelect.selectedIndex];
            const hljodfaraleiguGroup = document.getElementById('hljodfaraleiguGroup');
            const hljodfaraleigaCheckbox = document.getElementById('hljodfaraleiga');
            
            if (!hljodfaraleiguGroup) return;
            
            // S√¶kja vali√∞ hlj√≥√∞f√¶ri (nota actualName ef vi√∞ √°)
            let selectedInstrument = selectedOption ? (selectedOption.dataset.actualName || selectedOption.value) : '';
            
            // Athuga hvort hlj√≥√∞f√¶ri√∞ er √° listanum fyrir leigu
            if (selectedInstrument && hljodfariFyrirLeigu.includes(selectedInstrument)) {
                hljodfaraleiguGroup.classList.remove('hidden');
            } else {
                hljodfaraleiguGroup.classList.add('hidden');
                // Afvelja ef fali√∞
                if (hljodfaraleigaCheckbox) {
                    hljodfaraleigaCheckbox.checked = false;
                }
            }
        }
        
        // Global til a√∞ halda utan um valda n√°msgrein og deild
        let selectedSubjectName = null;
        let selectedDepartment = null;
        
        function showDepartmentChoiceModal(subjectName) {
            const subjectInfo = dualDepartmentSubjects[subjectName];
            
            let modal = document.getElementById('departmentModal');
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'departmentModal';
                modal.className = 'validation-modal';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="validation-modal-content" style="max-width: 500px;">
                    <h3 style="font-family: var(--font-display); color: var(--color-primary); margin-bottom: 16px;">${subjectName}</h3>
                    <p style="margin-bottom: 20px; color: var(--color-text);">${subjectInfo.question}</p>
                    <p style="margin-bottom: 24px;">
                        <a href="${subjectInfo.infoLink}" target="_blank" style="color: var(--color-primary);">
                            ‚ÑπÔ∏è Frekari uppl√Ωsingar um n√°mi√∞
                        </a>
                    </p>
                    <div class="choice-buttons" style="flex-direction: column; gap: 12px;">
                        <button type="button" class="btn btn-primary" style="width: 100%;" onclick="selectDepartment('${subjectName}', 'klassisk')">
                            Klass√≠sk deild
                        </button>
                        <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="selectDepartment('${subjectName}', 'rytmisk')">
                            Rytm√≠sk deild
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" style="margin-top: 16px; width: 100%;" onclick="closeDepartmentModal()">
                        H√¶tta vi√∞
                    </button>
                </div>
            `;
            
            modal.classList.add('visible');
        }
        
        function selectDepartment(subjectName, department) {
            const subjectInfo = dualDepartmentSubjects[subjectName];
            const deildInput = document.getElementById('deild');
            const deildGroup = document.getElementById('deildGroup');
            const namsgreinSelect = document.getElementById('namsgrein');
            
            selectedSubjectName = subjectName;
            selectedDepartment = department;
            
            if (department === 'klassisk') {
                // Uppf√¶ra select til a√∞ s√Ωna klass√≠ska nafni√∞
                const selectedOption = namsgreinSelect.options[namsgreinSelect.selectedIndex];
                selectedOption.dataset.deild = 'Klass√≠sk deild';
                selectedOption.dataset.actualName = subjectInfo.klassiskName;
                deildInput.value = 'Klass√≠sk deild';
            } else {
                // Uppf√¶ra select til a√∞ s√Ωna rytm√≠ska nafni√∞
                const selectedOption = namsgreinSelect.options[namsgreinSelect.selectedIndex];
                selectedOption.dataset.deild = 'Rytm√≠sk deild';
                selectedOption.dataset.actualName = subjectInfo.rytmiskName;
                deildInput.value = 'Rytm√≠sk deild';
            }
            
            deildGroup.style.display = 'block';
            
            // S√Ωna n√°mshlutfall fyrir √æessi f√∂g
            document.getElementById('namshlutiGroup').classList.remove('hidden');
            
            // Uppf√¶ra hlj√≥√∞f√¶raleigu s√Ωnileika
            updateHljodfaraleigaVisibility();
            
            closeDepartmentModal();
        }
        
        function closeDepartmentModal() {
            const modal = document.getElementById('departmentModal');
            if (modal) {
                modal.classList.remove('visible');
            }
            
            // Ef notandi h√¶ttir vi√∞, hreinsa vali√∞
            const namsgreinSelect = document.getElementById('namsgrein');
            const selectedOption = namsgreinSelect.options[namsgreinSelect.selectedIndex];
            
            if (selectedOption && !selectedOption.dataset.deild) {
                namsgreinSelect.value = '';
                document.getElementById('deild').value = '';
                document.getElementById('deildGroup').style.display = 'none';
            }
        }
        
        // Fylla inn sk√≥lalista
        function populateSkolar() {
            const bekkur = studentBekkur || 0;
            const age = studentAge || 0;
            const skoliSelect = document.getElementById('skoli');
            const skoliAnnadGroup = document.getElementById('skoliAnnadGroup');
            
            if (!skoliSelect) return;
            
            // Vista n√∫verandi val
            const currentValue = skoliSelect.value;
            
            skoliSelect.innerHTML = '<option value="">Veldu sk√≥la...</option>';
            
            let skolar = [];
            
            if (bekkur >= 1 && bekkur <= 10) {
                // Grunnsk√≥laaldur
                skolar = grunnskolar;
            } else if (age >= 15 && age <= 24) {
                // Framhaldssk√≥laaldur (15-24 √°ra)
                skolar = framhaldsskolar;
            }
            
            skolar.forEach(skoli => {
                const option = document.createElement('option');
                option.value = skoli;
                option.textContent = skoli;
                skoliSelect.appendChild(option);
            });
            
            // Endurheimta val ef √æa√∞ var til
            if (currentValue && skolar.includes(currentValue)) {
                skoliSelect.value = currentValue;
            }
            
            // S√Ωna/fela "Anna√∞" sk√Ωringarreit
            skoliSelect.addEventListener('change', function() {
                if (this.value === 'Anna√∞') {
                    skoliAnnadGroup.classList.remove('hidden');
                } else {
                    skoliAnnadGroup.classList.add('hidden');
                }
            });
        }

        // =============================================
        // TENGILI√êIR
        // =============================================
        function addContact() {
            contactCount++;
            const container = document.getElementById('contactsContainer');
            
            const types = ['Forr√°√∞ama√∞ur 2', 'Velunnari', 'Annar tengili√∞ur'];
            const typeIndex = Math.min(contactCount - 2, types.length - 1);
            const contactType = types[typeIndex];
            
            const contactHtml = `
                <div class="contact-card" id="contact${contactCount}">
                    <div class="contact-card-header">
                        <span class="contact-card-title">${contactType}</span>
                        <button type="button" class="btn-remove" onclick="removeContact(${contactCount})">Fjarl√¶gja</button>
                    </div>

                    <div class="form-group">
                        <label for="tengilidur${contactCount}_kennitala">Kennitala</label>
                        <input type="text" id="tengilidur${contactCount}_kennitala" name="tengilidur${contactCount}_kennitala" placeholder="0000000000" maxlength="10">
                    </div>

                    <div class="form-group">
                        <label for="tengilidur${contactCount}_nafn">Nafn</label>
                        <input type="text" id="tengilidur${contactCount}_nafn" name="tengilidur${contactCount}_nafn" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                    </div>

                    <div class="form-group">
                        <label for="tengilidur${contactCount}_heimili">Heimilisfang</label>
                        <input type="text" id="tengilidur${contactCount}_heimili" name="tengilidur${contactCount}_heimili" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tengilidur${contactCount}_postnumer">P√≥stn√∫mer</label>
                            <input type="text" id="tengilidur${contactCount}_postnumer" name="tengilidur${contactCount}_postnumer" placeholder="000" disabled>
                        </div>
                        <div class="form-group">
                            <label for="tengilidur${contactCount}_sveitarfelag">Sveitarf√©lag</label>
                            <input type="text" id="tengilidur${contactCount}_sveitarfelag" name="tengilidur${contactCount}_sveitarfelag" placeholder="S√≥tt √∫r √ûj√≥√∞skr√°..." disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tengilidur${contactCount}_simi1">S√≠man√∫mer 1</label>
                            <input type="tel" id="tengilidur${contactCount}_simi1" name="tengilidur${contactCount}_simi1" placeholder="000-0000">
                        </div>
                        <div class="form-group">
                            <label for="tengilidur${contactCount}_simi2">S√≠man√∫mer 2 <span class="optional">(valkv√¶tt)</span></label>
                            <input type="tel" id="tengilidur${contactCount}_simi2" name="tengilidur${contactCount}_simi2" placeholder="000-0000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tengilidur${contactCount}_netfang">Netfang</label>
                        <input type="email" id="tengilidur${contactCount}_netfang" name="tengilidur${contactCount}_netfang" placeholder="netfang@d√¶mi.is">
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="tengilidur${contactCount}_greidandi" name="tengilidur${contactCount}_greidandi">
                        <label for="tengilidur${contactCount}_greidandi">√ûessi tengili√∞ur er grei√∞andi</label>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', contactHtml);
            
            // B√¶ta vi√∞ event listener fyrir n√Ωja tengili√∞inn
            const newKtInput = document.getElementById(`tengilidur${contactCount}_kennitala`);
            const currentContactNum = contactCount; // Capture value for closure
            if (newKtInput) {
                newKtInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    if (this.value.length === 10) {
                        const parsed = parseKennitala(this.value);
                        if (parsed) {
                            fetchTengilidarFromThjodskra(this.value, currentContactNum);
                        }
                    }
                });
            }
            
            // Hide add button if max contacts reached
            if (contactCount >= 4) {
                document.getElementById('btnAddContact').classList.add('hidden');
            }
        }

        function removeContact(id) {
            const contact = document.getElementById(`contact${id}`);
            if (contact) {
                contact.remove();
                document.getElementById('btnAddContact').classList.remove('hidden');
            }
        }

        // =============================================
        // VALIDATION
        // =============================================
        function validateStep(step) {
            switch(step) {
                case 1:
                    return validateKennitala();
                case 2:
                    return validateStudentInfo();
                case 3:
                    return validateContacts();
                case 4:
                    return validateSubject();
                case 5:
                    return validateTerms();
                default:
                    return true;
            }
        }

        function validateKennitala() {
            const kt = document.getElementById('kennitala').value;
            const parsed = parseKennitala(kt);
            
            if (!parsed) {
                document.getElementById('kennitalaError').classList.add('visible');
                document.getElementById('kennitala').classList.add('error');
                return false;
            }
            
            return true;
        }

        function validateStudentInfo() {
            const simi1 = document.getElementById('simi1').value;
            const netfang = document.getElementById('netfang').value;
            const skoli = document.getElementById('skoli').value;
            const studentsprofStep2 = document.getElementById('studentsprofStep2');
            const studentsprofChecked = studentsprofStep2 && studentsprofStep2.checked;
            
            let errors = [];
            
            if (!simi1.trim()) {
                errors.push('‚Ä¢ S√≠man√∫mer 1 er nau√∞synlegt');
            }
            if (!netfang.trim()) {
                errors.push('‚Ä¢ Netfang er nau√∞synlegt');
            } else if (!isValidEmail(netfang)) {
                errors.push('‚Ä¢ Netfang er ekki √° r√©ttu formi (d√¶mi: nafn@d√¶mi.is)');
            }
            
            // Ef st√∫dentspr√≥fsbraut er valin, ver√∞ur a√∞ velja raunverulegan framhaldssk√≥la
            if (studentsprofChecked) {
                if (!skoli || skoli === 'Er ekki √≠ framhaldssk√≥la' || skoli === 'Anna√∞') {
                    errors.push('‚Ä¢ M√∂gulegt er a√∞ stunda n√°m √° st√∫dentspr√≥fsbraut vi√∞ √æessa sk√≥la: Menntask√≥lann √° Akureyri, Verkmenntask√≥lann √° Akureyri, Framhaldssk√≥lann √° Laugum, Framhaldssk√≥lann √° H√∫sav√≠k og Menntask√≥lann √° Tr√∂llaskaga. Vinsamlegast velji√∞ eitt af ofangreindu.\n\nAth: Nemendur √° Tr√∂llaskaga √æurfa a√∞ hafa samband vi√∞ sinn framhaldssk√≥la til a√∞ f√° n√°nari uppl√Ωsingar.');
                }
            }
            
            if (errors.length > 0) {
                showValidationError('Vinsamlegast lagf√¶r√∞u eftirfarandi:\n\n' + errors.join('\n'));
                return false;
            }
            
            return true;
        }

        function validateContacts() {
            // Skip validation if 18+
            if (studentAgeGroup && !studentAgeGroup.minors) {
                return true;
            }
            
            const kt = document.getElementById('tengilidur1_kennitala').value;
            const simi = document.getElementById('tengilidur1_simi1').value;
            const netfang = document.getElementById('tengilidur1_netfang').value;
            
            let errors = [];
            
            if (!kt.trim()) {
                errors.push('‚Ä¢ Kennitala forr√°√∞amanns er nau√∞synleg');
            }
            if (!simi.trim()) {
                errors.push('‚Ä¢ S√≠man√∫mer forr√°√∞amanns er nau√∞synlegt');
            }
            if (!netfang.trim()) {
                errors.push('‚Ä¢ Netfang forr√°√∞amanns er nau√∞synlegt');
            } else if (!isValidEmail(netfang)) {
                errors.push('‚Ä¢ Netfang forr√°√∞amanns er ekki √° r√©ttu formi (d√¶mi: nafn@d√¶mi.is)');
            }
            
            if (errors.length > 0) {
                showValidationError('Vinsamlegast lagf√¶r√∞u eftirfarandi:\n\n' + errors.join('\n'));
                return false;
            }
            
            return true;
        }

        function validateSubject() {
            const namsgrein = document.getElementById('namsgrein').value;
            
            if (!namsgrein) {
                showValidationError('Vinsamlegast veldu n√°msgrein.');
                return false;
            }
            
            // Athuga hvort a√∞alfag s√© vali√∞ ef Skapandi t√≥nlist
            if (namsgrein === 'Skapandi t√≥nlist') {
                const adafag = document.getElementById('adafag').value;
                if (!adafag) {
                    showValidationError('Vinsamlegast veldu a√∞alfag.\n\nNemendur √≠ Skapandi t√≥nlist √æurfa a√∞ velja a√∞alfag sem √æau f√° einkat√≠ma √≠.');
                    return false;
                }
            }
            
            return true;
        }

        function validateTerms() {
            const terms = document.getElementById('samthykkiSkilmala').checked;
            
            if (!terms) {
                showValidationError('√û√∫ ver√∞ur a√∞ sam√æykkja vi√∞skiptaskilm√°la til a√∞ senda ums√≥kn.\n\nVinsamlegast haka√∞u vi√∞ "√âg sam√æykki vi√∞skiptaskilm√°la" til a√∞ halda √°fram.');
                return false;
            }
            
            return true;
        }
        
        // =============================================
        // VALIDATION ERROR DISPLAY
        // =============================================
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function showValidationError(message) {
            // Create or get error modal
            let modal = document.getElementById('validationModal');
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'validationModal';
                modal.className = 'validation-modal';
                modal.innerHTML = `
                    <div class="validation-modal-content">
                        <div class="validation-modal-icon">‚ö†Ô∏è</div>
                        <div class="validation-modal-message"></div>
                        <button type="button" class="btn btn-primary" onclick="closeValidationModal()">√ç lagi</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            modal.querySelector('.validation-modal-message').textContent = message;
            modal.classList.add('visible');
        }
        
        function closeValidationModal() {
            const modal = document.getElementById('validationModal');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        // =============================================
        // FORM SUBMISSION
        // =============================================
        function submitForm() {
            if (!validateStep(5)) {
                return;
            }
            
            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('btnSubmit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sendi ums√≥kn...';
            
            // Collect all form data
            const formData = {
                // Student info
                kennitala: document.getElementById('kennitala').value,
                nafn: document.getElementById('nafn').value,
                tegund: 'N√Ω ums√≥kn',
                namsgrein: (function() {
                    const sel = document.getElementById('namsgrein');
                    const opt = sel.options[sel.selectedIndex];
                    return opt.dataset.actualName || opt.value;
                })(),
                deild: document.getElementById('deild').value,
                namshlutfall: document.querySelector('input[name="namshlutfall"]:checked')?.value || 'Heilt',
                studentsprof: document.getElementById('studentsprofStep2')?.checked || false,
                skoli: document.getElementById('skoli')?.value || '',
                fristundastyrkur: document.getElementById('fristundastyrkur')?.checked || false,
                hljodfaraleiga: document.getElementById('hljodfaraleiga')?.checked || false,
                myndefni: document.getElementById('myndefni')?.checked || false,
                netfangNemanda: document.getElementById('netfang').value,
                simiNemanda: document.getElementById('simi1').value,
                athugasemdNemanda: document.getElementById('athugasemd')?.value || '',
                adafagSkapandi: document.getElementById('adafag')?.value || '',
                
                // Heimilisfang nemanda (√∫r √ûj√≥√∞skr√° - l√∂gheimili)
                logheimiliNemanda: document.getElementById('logheimili')?.value || '',
                postnumerLogheimiliNemanda: document.getElementById('postnumer')?.value || '',
                sveitarfelagLogheimiliNemanda: document.getElementById('sveitarfelag')?.value || '',
                
                // Anna√∞ heimili nemanda
                heimiliNemanda: document.getElementById('annadHeimili')?.value || '',
                postnumerHeimiliNemanda: document.getElementById('postnumerAnnad')?.value || '',
                sveitarfelagHeimiliNemanda: document.getElementById('sveitarfelagAnnad')?.value || '',
                
                // Tengili√∞ur 1
                tengili√∞ur1Nafn: document.getElementById('tengilidur1_nafn')?.value || '',
                tengili√∞ur1Kennitala: document.getElementById('tengilidur1_kennitala')?.value || '',
                tengili√∞ur1Simi: document.getElementById('tengilidur1_simi1')?.value || '',
                tengili√∞ur1Netfang: document.getElementById('tengilidur1_netfang')?.value || '',
                tengili√∞ur1Greidandi: document.getElementById('tengilidur1_greidandi')?.checked || false,
                tengili√∞ur1Heimili: document.getElementById('tengilidur1_heimili')?.value || '',
                tengili√∞ur1Postnumer: document.getElementById('tengilidur1_postnumer')?.value || '',
                tengili√∞ur1Sveitarfelag: document.getElementById('tengilidur1_sveitarfelag')?.value || '',
                
                // Tengili√∞ur 2
                tengili√∞ur2Nafn: document.getElementById('tengilidur2_nafn')?.value || '',
                tengili√∞ur2Kennitala: document.getElementById('tengilidur2_kennitala')?.value || '',
                tengili√∞ur2Simi: document.getElementById('tengilidur2_simi1')?.value || '',
                tengili√∞ur2Netfang: document.getElementById('tengilidur2_netfang')?.value || '',
                tengili√∞ur2Greidandi: document.getElementById('tengilidur2_greidandi')?.checked || false,
                tengili√∞ur2Heimili: document.getElementById('tengilidur2_heimili')?.value || '',
                tengili√∞ur2Postnumer: document.getElementById('tengilidur2_postnumer')?.value || '',
                tengili√∞ur2Sveitarfelag: document.getElementById('tengilidur2_sveitarfelag')?.value || ''
            };
            
            console.log('Form data:', formData);
            
            // Power Automate URL
            const powerAutomateUrl = 'https://121760ab7a04ebae8bbd23b81b7a3b.4e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1b59cccd3fd64e189663b60d6d1697a1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9mYPS9IyuTu1fncoIQt1ZR-ErOOV_SWAE5fWZshW1xc';
            
            // Send to Power Automate
            fetch(powerAutomateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Villa vi√∞ a√∞ senda ums√≥kn');
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                
                // Hide current step
                document.querySelector(`.form-step[data-step="5"]`).classList.remove('active');
                
                // Show success
                document.querySelector(`.form-step[data-step="success"]`).classList.add('active');
                
                // Update progress to complete
                document.querySelectorAll('.step-indicator').forEach(ind => {
                    ind.classList.add('completed');
                    ind.innerHTML = '‚úì';
                });
                document.getElementById('progressLine').style.width = '100%';
            })
            .catch(error => {
                console.error('Error:', error);
                showValidationError('Villa kom upp vi√∞ a√∞ senda ums√≥kn. Vinsamlegast reyndu aftur e√∞a haf√∞u samband vi√∞ sk√≥lann.');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Senda ums√≥kn';
            });
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            // New application kennitala input
            const kennitalaInput = document.getElementById('kennitala');
            const btnNext1 = document.getElementById('btnNext1');
            const ageInfo = document.getElementById('ageInfo');
            
            kennitalaInput.addEventListener('input', function(e) {
                // Only allow numbers
                this.value = this.value.replace(/[^0-9]/g, '');
                
                const kt = this.value;
                const errorEl = document.getElementById('kennitalaError');
                
                if (kt.length === 10) {
                    const parsed = parseKennitala(kt);
                    
                    if (parsed) {
                        // Valid kennitala
                        errorEl.classList.remove('visible');
                        this.classList.remove('error');
                        btnNext1.disabled = false;
                        
                        // Calculate and display age
                        studentAge = calculateAge(parsed.birthDate);
                        studentAgeGroup = getAgeGroup(parsed.birthDate);
                        studentBekkur = calculateBekkur(parsed.birthDate);
                        
                        const months = ['jan√∫ar', 'febr√∫ar', 'mars', 'apr√≠l', 'ma√≠', 'j√∫n√≠', 
                                       'j√∫l√≠', '√°g√∫st', 'september', 'okt√≥ber', 'n√≥vember', 'desember'];
                        
                        document.getElementById('birthDate').textContent = 
                            `${parsed.day}. ${months[parsed.month - 1]} ${parsed.year}`;
                        document.getElementById('ageDisplay').textContent = `${studentAge} √°ra`;
                        
                        // S√Ωna bekk ef vi√∞ √°
                        let ageGroupText = studentAgeGroup.label;
                        if (studentBekkur >= 1 && studentBekkur <= 10) {
                            ageGroupText += ` ‚Äî ${studentBekkur}. bekkur`;
                        }
                        document.getElementById('ageGroup').textContent = ageGroupText;
                        
                        ageInfo.classList.remove('hidden');
                        
                        // S√¶kja uppl√Ωsingar √∫r √ûj√≥√∞skr√°
                        fetchFromThjodskra(kt);
                        
                    } else {
                        // Invalid kennitala
                        errorEl.classList.add('visible');
                        this.classList.add('error');
                        btnNext1.disabled = true;
                        ageInfo.classList.add('hidden');
                        studentAge = null;
                        studentAgeGroup = null;
                        studentBekkur = null;
                    }
                } else {
                    errorEl.classList.remove('visible');
                    this.classList.remove('error');
                    btnNext1.disabled = true;
                    ageInfo.classList.add('hidden');
                    studentAge = null;
                    studentAgeGroup = null;
                    studentBekkur = null;
                }
            });
            
            btnNext1.addEventListener('click', function() {
                if (validateKennitala()) {
                    goToStep(2);
                }
            });

            // Renewal kennitala input
            const renewalKennitalaInput = document.getElementById('renewalKennitala');
            const btnSearchRenewal = document.getElementById('btnSearchRenewal');
            
            renewalKennitalaInput.addEventListener('input', function(e) {
                // Only allow numbers
                this.value = this.value.replace(/[^0-9]/g, '');
                
                const kt = this.value;
                const errorEl = document.getElementById('renewalKennitalaError');
                const notFoundEl = document.getElementById('renewalNotFound');
                
                // Hide not found message when typing
                notFoundEl.classList.add('hidden');
                
                if (kt.length === 10) {
                    const parsed = parseKennitala(kt);
                    
                    if (parsed) {
                        errorEl.classList.remove('visible');
                        this.classList.remove('error');
                        btnSearchRenewal.disabled = false;
                    } else {
                        errorEl.classList.add('visible');
                        this.classList.add('error');
                        btnSearchRenewal.disabled = true;
                    }
                } else {
                    errorEl.classList.remove('visible');
                    this.classList.remove('error');
                    btnSearchRenewal.disabled = true;
                }
            });
            
            // Tengili√∞ur 1 kennitala - s√¶kja √∫r √ûj√≥√∞skr√°
            const tengilidur1KtInput = document.getElementById('tengilidur1_kennitala');
            if (tengilidur1KtInput) {
                tengilidur1KtInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    if (this.value.length === 10) {
                        const parsed = parseKennitala(this.value);
                        if (parsed) {
                            fetchTengilidarFromThjodskra(this.value, 1);
                        }
                    }
                });
            }
            
            // Tengili√∞ur 2 kennitala - s√¶kja √∫r √ûj√≥√∞skr√°
            const tengilidur2KtInput = document.getElementById('tengilidur2_kennitala');
            if (tengilidur2KtInput) {
                tengilidur2KtInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    if (this.value.length === 10) {
                        const parsed = parseKennitala(this.value);
                        if (parsed) {
                            fetchTengilidarFromThjodskra(this.value, 2);
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
